<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Game Admin</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #ccc;
            margin-bottom: 10px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-bottom: none;
            background: #eee;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }

        .tab.active {
            background: #fff;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 6px;
            text-align: left;
        }

        button {
            margin: 3px;
        }

        #popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
        }

        .popup-content {
            margin: 5% auto;
            background: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            max-width: 80vw;
            max-height: 80vh;
            width: 100%;
        }

        .popup-header,
        .popup-footer {
            padding: 10px;
            flex: 0 0 auto;
        }

        .popup-body {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .popup-body label {
            display: block;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .popup-body input {
            width: 100%;
            padding: 6px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <h1>Game Admin</h1>
    <div class="tabs" id="tabs"></div>
    <div id="tabContents"></div>

    <div id="popup" class="popup" style="display:none;">
        <div class="popup-content">
            <div class="popup-header">
                <h2 id="popupTitle" style="display:inline-block; margin:0;"></h2>
                <button style="float:right;" onclick="closePopup()">âœ•</button>
            </div>
            <div class="popup-body" id="popupForm"></div>
            <div class="popup-footer" style="text-align:right;">
                <button onclick="submitForm()">Save</button>
                <button onclick="closePopup()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let games = [];
        let currentGame = null;
        let editServer = null;
        let popupType = null;
        const baseKeys = [{name: "ip", label: "IP", type: "ip"}, {name: "port", label: "Port", type: "integer"}];
        const baseKeyNames = baseKeys.map(k => k.name);

        async function loadGames() {
            const res = await fetch('/api/games');
            games = await res.json();
            renderTabs();
        }

        function renderTabs() {
            const tabs = document.getElementById('tabs');
            const contents = document.getElementById('tabContents');
            tabs.innerHTML = '';
            contents.innerHTML = '';
            games.forEach((game, i) => {
                game.shownFields = game.keys.map(k => k.name);
                const filters = JSON.parse(localStorage.getItem(game.name + '-fields') || '[]');
                if (filters.length) game.shownFields = game.shownFields.filter(name => filters.includes(name));
                else game.shownFields = game.shownFields.slice(0, 10);

                const tab = document.createElement('div');
                tab.className = 'tab' + (i === 0 ? ' active' : '');
                tab.textContent = game.name;
                tab.onclick = () => switchTab(game);
                tabs.appendChild(tab);

                const content = document.createElement('div');
                content.className = 'tab-content' + (i === 0 ? ' active' : '');
                content.id = 'content-' + game.name;

                const refreshBtn = document.createElement('button');
                refreshBtn.textContent = 'Refresh';
                refreshBtn.onclick = () => loadServers(game);
                content.appendChild(refreshBtn);

                const addBtn = document.createElement('button');
                addBtn.textContent = 'Add';
                addBtn.onclick = () => openServerPopup(game, null);
                content.appendChild(addBtn);

                const fieldsBtn = document.createElement('button');
                fieldsBtn.textContent = 'Fields';
                fieldsBtn.onclick = () => openFieldsPopup(game);
                content.appendChild(fieldsBtn);

                const table = document.createElement('table');
                table.id = 'table-' + game.name;
                content.appendChild(table);

                contents.appendChild(content);

                if (i === 0) {
                    currentGame = game;
                    loadServers(game);
                }
            });
        }

        function switchTab(game) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            currentGame = game;
            document.querySelector(`#content-${game.name}`).classList.add('active');
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent === game.name) tab.classList.add('active');
            });
            loadServers(game);
        }

        async function loadServers(game) {
            const res = await fetch(`/api/servers?game=${encodeURIComponent(game.name)}&fields=${encodeURIComponent(game.keys.map(k => k.name).join(','))}`);
            const servers = await res.json();
            renderTable(game, servers);
        }

        function renderTable(game, servers) {
            const table = document.getElementById('table-' + game.name);
            table.innerHTML = '';

            // header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            game.nameToKey = {};
            baseKeys.concat(game.keys).forEach(k => {
                game.nameToKey[k.name] = k;
                if (baseKeyNames.includes(k.name) || game.shownFields.includes(k.name)) {
                    const th = document.createElement('th');
                    th.dataset.gamekey = k.name;
                    th.textContent = k.label || k.name;
                    headerRow.appendChild(th);
                }
            });
            headerRow.appendChild(document.createElement('th')).textContent = 'Actions';
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // body
            const tbody = document.createElement('tbody');
            if (servers.length === 0) {
                tbody.insertAdjacentHTML('afterbegin', '<tr><td colspan="' + (baseKeys.length + game.shownFields.length + 1) + '">No servers registered</td></tr>');
            } else {
                servers.forEach(srv => {
                    const row = document.createElement('tr');
                    baseKeyNames.concat(game.shownFields).forEach(name => {
                        const td = document.createElement('td');
                        td.dataset.gamekey = name;
                        td.textContent = srv[name] ?? '';
                        row.appendChild(td);
                    });
                    const actions = document.createElement('td');
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.onclick = () => openServerPopup(game, srv);
                    actions.appendChild(editBtn);

                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.onclick = () => deleteServer(game, srv);
                    actions.appendChild(delBtn);

                    row.appendChild(actions);
                    tbody.appendChild(row);
                });
            }
            table.appendChild(tbody);
        }

        function openServerPopup(game, server) {
            popupType = 'server';
            currentGame = game;
            editServer = server;
            document.getElementById('popupTitle').textContent = server ? 'Edit Server' : 'Add Server';
            const form = document.getElementById('popupForm');
            form.innerHTML = '';
            baseKeys.concat(game.keys).forEach(k => {
                const container = document.createElement('div');
                const label = document.createElement('label');
                label.textContent = k.label || k.name;
                label.htmlFor = 'key-' + k.name;
                const input = document.createElement('input');
                input.id = 'key-' + k.name;
                input.name = k.name;
                input.value = server ? (server[k.name] ?? '') : '';
                if (k.type === "string") {
                    input.type = "text";
                } else if (k.type === "integer") {
                    input.type = "number";
                    input.step = "1";
                } else if (k.type === "float") {
                    input.type = "number";
                    input.step = "any";
                } else if (k.type == "boolean") {
                    input.type = "checkbox";
                    if (server && server[k.name] == '1') {
                        input.value = 'on';
                        input.checked = true;
                    }
                } else if (k.type == "ip") {
                    input.type = "text";
                    input.pattern = "^([0-9]{1,3}\.){3}[0-9]{1,3}$";
                } else {
                    input.type = "text";
                }

                container.appendChild(label);
                container.appendChild(input);
                form.appendChild(container);
            });
            document.getElementById('popup').style.display = 'flex';
        }

        function openFieldsPopup(game) {
            popupType = 'fields';
            currentGame = game;
            document.getElementById('popupTitle').textContent = "Select shown fields";
            const form = document.getElementById('popupForm');
            form.innerHTML = '';
            game.keys.forEach(k => {
                const container = document.createElement('div');
                const label = document.createElement('label');
                label.textContent = k.label || k.name;
                label.htmlFor = 'key-' + k.name;
                const input = document.createElement('input');
                input.id = 'key-' + k.name;
                input.name = k.name;
                input.type = "checkbox";
                if (game.shownFields.includes(k.name)) {
                    input.value = 'on';
                    input.checked = true;
                }

                container.appendChild(label);
                container.appendChild(input);
                form.appendChild(container);
            });
            document.getElementById('popup').style.display = 'flex';
        }

        function closePopup() {
            document.getElementById('popup').style.display = 'none';
        }

        async function submitForm() {
            if (popupType == 'server') {
                const params = new URLSearchParams();
                params.append('game', currentGame.name);
                document.querySelectorAll('#popupForm input').forEach(el => {
                    if (el.name && el.name in currentGame.nameToKey) {
                        const type = currentGame.nameToKey[el.name].type || 'text';
                        if (type == 'boolean') {
                            params.append(el.name, el.checked ? '1' : '0');
                        } else {
                            params.append(el.name, el.value);
                        }
                    }
                });

                await fetch(`/api/server?${params.toString()}`, { method: 'POST' });

                closePopup();
                loadServers(currentGame);
            }
            else if (popupType == 'fields') {
                currentGame.shownFields = [];
                document.querySelectorAll('#popupForm input').forEach(el => {
                    if (el.checked) currentGame.shownFields.push(el.name);
                });
                localStorage.setItem(currentGame.name + '-fields', JSON.stringify(currentGame.shownFields));
                loadServers(currentGame);
                closePopup();
            }
        }

        async function deleteServer(game, srv) {
            if (!confirm("Delete this server?")) return;
            const params = new URLSearchParams({ game: game.name, ip: srv.ip, port: srv.port });
            await fetch(`/api/server?${params.toString()}`, { method: 'DELETE' });
            loadServers(game);
        }

        loadGames();
    </script>
</body>

</html>